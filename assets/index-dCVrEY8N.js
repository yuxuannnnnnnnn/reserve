import{initializeApp as se}from"https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";import{getDatabase as oe,update as A,ref as R,onValue as W}from"https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";(function(){const C=document.createElement("link").relList;if(C&&C.supports&&C.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))f(a);new MutationObserver(a=>{for(const p of a)if(p.type==="childList")for(const y of p.addedNodes)y.tagName==="LINK"&&y.rel==="modulepreload"&&f(y)}).observe(document,{childList:!0,subtree:!0});function i(a){const p={};return a.integrity&&(p.integrity=a.integrity),a.referrerPolicy&&(p.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?p.credentials="include":a.crossOrigin==="anonymous"?p.credentials="omit":p.credentials="same-origin",p}function f(a){if(a.ep)return;a.ep=!0;const p=i(a);fetch(a.href,p)}})();const H=window.location.hostname.includes("github.io"),ie={apiKey:"AIzaSyCp8_-QPKaR6Q6ECK9np3OPqW6dO967wpk",authDomain:"reserve-a3e41.firebaseapp.com",databaseURL:"https://reserve-a3e41-default-rtdb.firebaseio.com",projectId:"reserve-a3e41",storageBucket:"reserve-a3e41.firebasestorage.app",messagingSenderId:"1:25864343238:web:7d31cb753ae557b49391c7",appId:"G-EX5CQE079X"},re={apiKey:"AIzaSyAqoYkxNQb5zCmp2VtPNeSAfUXU_ZxJ_l8",authDomain:"https://reserve-demo-ae1eb-default-rtdb.firebaseio.com",databaseURL:"reserve-demo-ae1eb",projectId:"reserve-demo-ae1eb.firebasestorage.app",storageBucket:"3910946722",messagingSenderId:"1:3910946722:web:80a1bd5021434512ca6cfb",appId:"G-PC427R3YWP"};let $;H?($=ie,console.log("使用正式環境配置")):($=re,console.log("使用測試環境配置"));const ae=se($),L=oe(ae);console.log("Firebase 初始化於環境:",H?"正式環境":"測試環境");document.addEventListener("DOMContentLoaded",function(){function m(n,e){const t=document.getElementById("syncStatus");t.textContent=e,t.className="sync-status "+n,t.style.display="block",n!=="syncing"&&setTimeout(()=>{t.style.opacity="0",setTimeout(()=>{t.style.display="none",t.style.opacity="1"},300)},3e3)}const C=[1,2,4,5,6,7,8,10];let i={},f=[],a=[],p=1,y=1,N="先生",x="先生",b=!1,I=!1;function z(){const n=R(L,".info/connected");W(n,t=>{t.val()===!0?(console.log("已連接到 Firebase"),m("synced","已連接到伺服器"),b&&D()):(console.log("未連接到 Firebase"),m("sync-error","伺服器連接斷開"))});function e(t,s,o){let r=0;const d=5;function c(){const u=R(L,t);W(u,s,l=>{if(console.error(`${t} 監聽錯誤:`,l),o&&o(l),r<d){r++;const h=Math.min(1e3*Math.pow(2,r),3e4);console.log(`嘗試重新監聽 ${t}，${r}/${d}，等待 ${h}ms`),setTimeout(()=>{c()},h)}else m("sync-error",`監聽 ${t} 失敗，請重新整理頁面`)})}c()}e("tableStatus",t=>{if(!I){const s=t.val();s&&(i={},Object.keys(s).forEach(o=>{i[o]=O(s[o])}),g(),m("synced","已同步桌位狀態"))}},t=>{m("sync-error","同步錯誤：桌位狀態")}),e("reservedList",t=>{if(!I){const s=t.val();s&&(f=[],Object.values(s).forEach(o=>{f.push(o)}),f.length>0&&(p=Math.max(...f.map(o=>o.id))+1),E(),m("synced","已同步訂位清單"))}},t=>{m("sync-error","同步錯誤：訂位清單")}),e("waitingList",t=>{if(!I){const s=t.val();s&&(a=[],Object.values(s).forEach(o=>{a.push(o)}),a.length>0&&(y=Math.max(...a.map(o=>o.id))+1),w(),m("synced","已同步候位清單"))}},t=>{m("sync-error","同步錯誤：候位清單")}),e("counters",t=>{if(!I){const s=t.val();s&&(s.reservation&&s.reservation>p&&(p=s.reservation),s.waiting&&s.waiting>y&&(y=s.waiting),m("synced","已同步計數器"))}},t=>{m("sync-error","同步錯誤：計數器")})}function M(n){if(!n)return n;const e={};return Object.keys(n).forEach(t=>{n[t]instanceof Date?e[t]={__isDate:!0,timestamp:n[t].getTime()}:typeof n[t]=="object"&&n[t]!==null?e[t]=M(n[t]):e[t]=n[t]}),e}function O(n){if(!n)return n;const e={};return Object.keys(n).forEach(t=>{n[t]&&n[t].__isDate&&n[t].timestamp?e[t]=new Date(n[t].timestamp):typeof n[t]=="object"&&n[t]!==null?e[t]=O(n[t]):e[t]=n[t]}),e}let B=null;function v(){b=!0,B&&clearTimeout(B),_(),B=setTimeout(()=>{D()},500)}function D(){if(!I){I=!0,m("syncing","資料同步中...");try{const n={};Object.keys(i).forEach(t=>{n[t]=M(i[t])});const e={};e.tableStatus=n,e.reservedList=f.reduce((t,s,o)=>(t[o]=s,t),{}),e.waitingList=a.reduce((t,s,o)=>(t[o]=s,t),{}),e.counters={reservation:p,waiting:y},A(R(L),e).then(()=>{I=!1,b=!1,m("synced","資料已同步"),console.log("同步成功，時間：",new Date().toLocaleTimeString())}).catch(t=>{console.error("Firebase同步錯誤:",t),I=!1,m("sync-error","同步失敗："+t.message),setTimeout(()=>{b&&(console.log("嘗試重新同步..."),D())},3e3)})}catch(n){console.error("同步數據處理錯誤:",n),I=!1,m("sync-error","處理數據錯誤："+n.message)}}}function _(){try{localStorage.setItem("tableStatus",JSON.stringify(i)),localStorage.setItem("reservedList",JSON.stringify(f)),localStorage.setItem("waitingList",JSON.stringify(a)),localStorage.setItem("reservationCounter",p),localStorage.setItem("waitingCounter",y),localStorage.setItem("backupTime",new Date().toISOString()),console.log("已備份到本地儲存")}catch(n){console.error("備份到本地儲存失敗:",n)}}function S(){m("syncing","正在清除預約資料...");try{const n={};Object.keys(i).forEach(t=>{n[t]={status:"empty",name:"",phone:"",people:0,time:null,notes:""}});const e={};return e.tableStatus=n,e.reservedList={},e.waitingList={},e.counters={reservation:1,waiting:1},A(R(L),e).then(()=>(console.log("預約資料已重置，時間：",new Date().toLocaleTimeString()),m("synced","預約資料已重置"),i=n,f=[],a=[],p=1,y=1,g(),E(),w(),localStorage.setItem("lastResetDate",new Date().toDateString()),!0)).catch(t=>(console.error("重置錯誤:",t),m("sync-error","重置失敗："+t.message),!1))}catch(n){return console.error("重置數據處理錯誤:",n),m("sync-error","處理數據錯誤："+n.message),!1}}function k(){function n(){const s=new Date,o=new Date(s);o.setDate(o.getDate()+1),o.setHours(0,0,0,0);const r=o-s;console.log(`下次預約重置將在 ${new Date(o).toLocaleString()} 執行，剩餘 ${Math.floor(r/6e4)} 分鐘`),setTimeout(()=>{console.log("執行每日預約重置..."),S().then(()=>{n()})},r)}n();const e=localStorage.getItem("lastResetDate"),t=new Date().toDateString();if(e!==t){const s=new Date,o=new Date(s);o.setHours(0,0,0,0),s.getTime()-o.getTime()<60*60*1e3&&(console.log("頁面載入檢測到今日尚未重置預約，執行重置..."),S())}}window.addEventListener("load",function(){k();const n=document.getElementById("manualResetBtn");n&&n.addEventListener("click",function(){confirm("確定要清除所有預約資料嗎？此操作無法復原！")&&S()})}),window.openTab=function(n){const e=document.getElementsByClassName("tab-content");for(let o=0;o<e.length;o++)e[o].classList.remove("active");const t=document.getElementsByClassName("tab-button");for(let o=0;o<t.length;o++)t[o].classList.remove("active");document.getElementById(n).classList.add("active");const s=document.getElementsByClassName("tab-button");for(let o=0;o<s.length;o++)s[o].getAttribute("onclick").includes(n)&&s[o].classList.add("active")};function g(){const n=document.getElementById("tables");n.innerHTML="",C.forEach(e=>{var r,d,c,u;const t=((r=i[e])==null?void 0:r.status)||"empty",s=document.createElement("div");if(s.className=`table ${t}`,(d=i[e])!=null&&d.reservationId){const l=document.createElement("div");l.className="reservation-id",l.textContent=`訂${i[e].reservationId}`,s.appendChild(l)}if((c=i[e])!=null&&c.secondaryReservationId){const l=document.createElement("div");l.className="reservation-id-secondary",l.textContent=`訂${i[e].secondaryReservationId}`,s.appendChild(l)}const o=document.createElement("div");if(o.textContent=`A${e}`,s.appendChild(o),t==="occupied"&&i[e].startTime){const l=i[e].startTime,h=new Date(l.getTime()+90*6e4),T=document.createElement("div");T.className="time-info",T.innerHTML=`<div style="color: #005435;">${P(l)} 入座<br>
                <div style="color: #FFFFFF;">${P(h)} 結束`,s.appendChild(T)}if(t==="reserved"&&((u=i[e])!=null&&u.reservedTime)){const l=document.createElement("div");l.className="time-info";const h=i[e].reservedTime,T=J(h),ne=Q(h);l.innerHTML=`<div class="before-time">${T} 前可接</div>
                <div>${h}</div>
                <div class="after-time">${ne} 後可接</div>`,s.appendChild(l)}if(s.onclick=()=>U(e),t==="occupied"){let l;const h=()=>{l=setTimeout(()=>{K(e)},500)},T=()=>{clearTimeout(l)};s.addEventListener("touchstart",h),s.addEventListener("touchend",T),s.addEventListener("touchmove",T),s.addEventListener("mousedown",h),s.addEventListener("mouseup",T),s.addEventListener("mouseleave",T)}n.appendChild(s)})}function K(n){const e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.zIndex="1000";const t=document.createElement("div");t.style.backgroundColor="#fff",t.style.padding="20px",t.style.borderRadius="10px",t.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.1)",t.style.width="90%",t.style.maxWidth="280px";const s=document.createElement("input");s.type="text",s.inputMode="numeric",s.placeholder="輸入 4 位數字（11:30=1130）",s.style.width="100%",s.style.padding="10px",s.style.fontSize="16px",s.style.marginBottom="10px",s.style.boxSizing="border-box",s.style.setProperty("--placeholder-color","#999999"),s.style.setProperty("--placeholder-opacity","1"),s.addEventListener("input",()=>{s.style.setProperty("--placeholder-color",s.value?"transparent":"#999999")});const o=document.createElement("style");o.textContent=`
    input::placeholder {
        color: var(--placeholder-color, #999999);
        opacity: var(--placeholder-opacity, 1);
    }
`,document.head.appendChild(o);const r=document.createElement("button");r.textContent="確認",r.style.padding="10px 20px",r.style.fontSize="16px",r.style.backgroundColor="#000000",r.style.color="#fff",r.style.border="none",r.style.borderRadius="5px",r.style.cursor="pointer",r.onclick=()=>{const d=s.value;if(d&&/^\d{4}$/.test(d)){const c=parseInt(d.slice(0,2),10),u=parseInt(d.slice(2,4),10);if(c>=0&&c<24&&u>=0&&u<60){const l=new Date;l.setHours(c,u,0,0),i[n].startTime=l,g()}else alert("輸入時間無效！請輸入有效的 4 位數字（例如 0930 表示 09:30）。")}else alert("輸入格式錯誤！請輸入 4 位數字（例如 0930 表示 09:30）。");document.body.removeChild(e)},e.onclick=d=>{d.target===e&&document.body.removeChild(e)},t.appendChild(s),t.appendChild(r),e.appendChild(t),document.body.appendChild(e)}function U(n){const e=i[n];if(!e||e.status==="empty"){i[n]={status:"occupied",startTime:new Date},v(),g();return}if(!((e==null?void 0:e.status)==="reserved"&&!(e!=null&&e.secondaryReservationId))){if((e==null?void 0:e.status)==="reserved"&&(e!=null&&e.secondaryReservationId)){const t=e.reservationId,s=e.reservedTime;i[n].reservationId=e.secondaryReservationId,i[n].reservedTime=e.secondaryReservedTime,i[n].secondaryReservationId=t,i[n].secondaryReservedTime=s,v(),g();return}if((e==null?void 0:e.status)==="occupied"&&(e!=null&&e.secondaryReservationId)){i[n]={status:"finished",secondaryReservationId:e.secondaryReservationId,secondaryReservedTime:e.secondaryReservedTime},v(),g();return}if((e==null?void 0:e.status)==="finished"&&(e!=null&&e.secondaryReservationId)){i[n]={status:"reserved",reservationId:e.secondaryReservationId,reservedTime:e.secondaryReservedTime,secondaryReservationId:null,secondaryReservedTime:null},v(),g();return}e.status==="occupied"?i[n]={status:"finished"}:e.status==="finished"&&(i[n]={status:"empty"}),v(),g(),E(),w()}}function P(n){return n.toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit",hour12:!1})}function J(n){const[e,t]=n.split(":").map(Number),s=new Date;return s.setHours(e),s.setMinutes(t-90),`${String(s.getHours()).padStart(2,"0")}:${String(s.getMinutes()).padStart(2,"0")}`}function Q(n){const[e,t]=n.split(":").map(Number),s=new Date;return s.setHours(e),s.setMinutes(t+90),`${String(s.getHours()).padStart(2,"0")}:${String(s.getMinutes()).padStart(2,"0")}`}function F(n,e){const[t,s]=n.split(":").map(Number),[o,r]=e.split(":").map(Number),d=t*60+s,c=o*60+r;return Math.abs(d-c)>=90}window.selectTitleReserved=function(n){N=n,document.getElementById("mrButtonReserved").classList.toggle("active",n==="先生"),document.getElementById("msButtonReserved").classList.toggle("active",n==="小姐")},window.selectTitleWaiting=function(n){x=n,document.getElementById("mrButtonWaiting").classList.toggle("active",n==="先生"),document.getElementById("msButtonWaiting").classList.toggle("active",n==="小姐")},window.addToReservedList=function(){const n=document.getElementById("reservedCount").value,e=document.getElementById("reservedName").value,t=document.getElementById("reservedPhone").value,s=document.getElementById("reservedTime").value;if(!n||!e||!t||!s)return;const o={id:p++,count:n,name:e,title:N,phone:t,reservedTime:s,assignedTable:null};f.push(o),v(),ee(),E()},window.addToWaitingList=function(){const n=document.getElementById("waitingCount").value,e=document.getElementById("waitingName").value,t=document.getElementById("waitingPhone").value;if(!n||!e||!t)return;const s={id:y++,count:n,name:e,title:x,phone:t,assignedTable:null};a.push(s),v(),te(),w()};function E(){const n=document.getElementById("reservedList");n.innerHTML="",f.forEach((e,t)=>{const s=document.createElement("div");s.className="waitlist-container";const o=document.createElement("li");o.className="waitlist-item",o.innerHTML=`
    <span class="guest-info">
        <span class="guest-id-corner">訂${e.id}</span>
        <span class="guest-details">${e.count}位 - ${e.name} ${e.title}  - ${e.phone} - 訂位時間 ${e.reservedTime}</span>
    </span>
`;const r=document.createElement("div");if(r.className="button-container",!e.assignedTable)C.forEach(c=>{const u=document.createElement("button");u.className="table-button",u.textContent=`A${c}`,X(c,e.reservedTime)?(u.disabled=!0,u.style.backgroundColor="#cccccc",u.style.cursor="not-allowed",u.title="此桌已有時間相近的預訂"):u.onclick=()=>q(e.id,c,e.reservedTime,t),r.appendChild(u)});else{const c=document.createElement("button");c.className="confirm-button",c.textContent=`確認入座 A${e.assignedTable}`,c.onclick=()=>G(e.assignedTable,t),r.appendChild(c)}const d=document.createElement("button");d.className="cancel-button",d.textContent="取消訂位",d.onclick=()=>Y(t),r.appendChild(d),o.appendChild(r),s.appendChild(o),n.appendChild(s)})}function w(){const n=document.getElementById("waitingList");n.innerHTML="",a.forEach((e,t)=>{const s=document.createElement("div");s.className="waitlist-container";const o=document.createElement("li");o.className="waitlist-item",o.innerHTML=`
    <span class="guest-info waiting-guest-info">
        <span class="guest-id-corner">候${e.id}</span>
        <span class="guest-details">
            ${e.count}位 - ${e.name} ${e.title} - ${e.phone}-
            ${e.assignedTable?`<span class="assigned-table">A${e.assignedTable}</span>`:""}
        </span>
    </span>
`;const r=document.createElement("div");if(r.className="button-container",!e.assignedTable)C.forEach(c=>{const u=document.createElement("button");u.className="table-button",u.textContent=`A${c}`,u.onclick=()=>Z(c,t),r.appendChild(u)});else{const c=document.createElement("button");c.className="confirm-button",c.textContent=`確認入座 A${e.assignedTable}`,c.onclick=()=>V(e.assignedTable,t),r.appendChild(c)}const d=document.createElement("button");d.className="cancel-button",d.textContent="取消候位",d.onclick=()=>j(t),r.appendChild(d),o.appendChild(r),s.appendChild(o),n.appendChild(s)})}function X(n,e){const t=i[n];return!t||t.status!=="reserved"?!1:t.secondaryReservationId?!0:!F(t.reservedTime,e)}function q(n,e,t,s){const o=i[e];o&&o.status==="occupied"?i[e]={...o,secondaryReservationId:n,secondaryReservedTime:t}:!o||o.status!=="reserved"?i[e]={status:"reserved",reservationId:n,reservedTime:t}:o.secondaryReservationId||F(o.reservedTime,t)&&(i[e].secondaryReservationId=n,i[e].secondaryReservedTime=t),f[s].assignedTable=e,v(),g(),E()}function G(n,e){if(console.log("confirmSeating 被调用:",{table:n,index:e}),n==null){console.error("错误: 桌号为空"),alert("错误: 无法确认入座，桌号不存在");return}if(e===void 0||e<0||e>=f.length){console.error("错误: 无效的订位索引",e,"列表长度:",f.length),alert("错误: 无法确认入座，订位记录不存在");return}const t=f[e];if(console.log("订位信息:",t),!t){console.error("错误: 订位信息不存在"),alert("错误: 无法获取订位信息");return}if(!i[n])console.log("桌子状态不存在，创建新状态"),i[n]={status:"occupied",startTime:new Date};else{console.log("当前桌子状态:",i[n]);const s=i[n].reservationId,o=i[n].secondaryReservationId;if(console.log("比较ID:",{currentReservationId:s,secondaryReservationId:o,reservationId:t.id}),s===t.id){console.log("确认主要预订入座");const r={status:"occupied",startTime:new Date};o&&(r.secondaryReservationId=o,r.secondaryReservedTime=i[n].secondaryReservedTime),i[n]=r}else if(o===t.id){console.log("尝试确认次要预订入座 - 需要先切换"),alert("請先切換為此預訂，再確認入座");return}else console.log("预订ID与桌子不匹配，强制设置入座状态"),i[n]={status:"occupied",startTime:new Date}}try{console.log("移除预订，索引:",e),f.splice(e,1),console.log("标记数据已更改"),v(),console.log("重新渲染界面"),g(),E(),console.log("入座操作完成")}catch(s){console.error("处理预订时发生错误:",s),alert("处理预订时发生错误: "+s.message)}}function V(n,e){i[n]={status:"occupied",startTime:new Date},a.splice(e,1),v(),g(),w()}function Y(n){const e=f[n],t=e.assignedTable;if(t){const s=i[t];s.reservationId===e.id?s.secondaryReservationId?i[t]={status:"reserved",reservationId:s.secondaryReservationId,reservedTime:s.secondaryReservedTime}:delete i[t]:s.secondaryReservationId===e.id&&(delete s.secondaryReservationId,delete s.secondaryReservedTime)}f.splice(n,1),v(),g(),E()}function Z(n,e){a[e].assignedTable=n,v(),g(),w()}function j(n){a.splice(n,1),v(),w()}function ee(){document.getElementById("reservedCount").value="",document.getElementById("reservedName").value="",document.getElementById("reservedPhone").value="",document.getElementById("reservedTime").value="11:00"}function te(){document.getElementById("waitingCount").value="",document.getElementById("waitingName").value="",document.getElementById("waitingPhone").value=""}window.onload=function(){document.getElementById("mrButtonReserved").classList.add("active"),document.getElementById("mrButtonWaiting").classList.add("active"),z(),g(),E(),w(),b=!1}});
